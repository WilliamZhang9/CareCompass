<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emergency Medical Facilities Map</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
    }

    .container {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .map {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .sidebar {
      width: 350px;
      background: white;
      border-left: 1px solid #e5e5e5;
      overflow-y: auto;
      box-shadow: -2px 0 4px rgba(0, 0, 0, 0.05);
    }

    .facilities-list {
      padding: 0;
      list-style: none;
    }

    .facility-item {
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s, border-left-color 0.2s;
      border-left: 4px solid transparent;
    }

    .facility-item:hover {
      background-color: #f9f9f9;
      border-left-color: #667eea;
    }

    .facility-item.active {
      background-color: #f0f4ff;
      border-left-color: #667eea;
    }

    .facility-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .facility-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .facility-type.emergency {
      background-color: #fee;
      color: #c33;
    }

    .facility-type.urgent_care {
      background-color: #fef3cd;
      color: #856404;
    }

    .facility-type.clinic {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .facility-info {
      font-size: 13px;
      color: #666;
      line-height: 1.5;
    }

    .facility-distance {
      font-weight: 600;
      color: #667eea;
      margin-top: 6px;
      font-size: 14px;
    }

    .facility-eta {
      color: #e74c3c;
      font-weight: 500;
      font-size: 13px;
    }

    .facility-rating {
      margin-top: 6px;
      font-size: 13px;
      color: #f39c12;
    }

    .marker-popup {
      font-family: Arial, sans-serif;
    }

    .popup-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 4px;
    }

    .popup-type {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .popup-type.emergency {
      background-color: #fee;
      color: #c33;
    }

    .popup-type.urgent_care {
      background-color: #fef3cd;
      color: #856404;
    }

    .popup-type.clinic {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .popup-info {
      font-size: 12px;
      color: #555;
      margin-bottom: 3px;
    }

    .no-facilities {
      padding: 20px;
      text-align: center;
      color: #999;
    }

    @media (max-width: 768px) {
      .content {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: 40%;
        border-left: none;
        border-top: 1px solid #e5e5e5;
      }

      .map {
        height: 60%;
      }
    }

    .legend {
      background: white;
      padding: 12px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      font-size: 12px;
      line-height: 1.8;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .legend-color.emergency {
      background: #e74c3c;
    }

    .legend-color.urgent_care {
      background: #f39c12;
    }

    .legend-color.clinic {
      background: #3498db;
    }

    .legend-color.user {
      background: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• Emergency Medical Facilities</h1>
      <p>Montreal, Canada - Find the nearest medical facility</p>
    </div>

    <div class="content">
      <div class="map">
        <div id="map"></div>
      </div>

      <div class="sidebar">
        <ul class="facilities-list" id="facilitiesList">
          <li class="no-facilities">Loading facilities...</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Initialize map centered on McGill University
    const map = L.map("map").setView([45.5047, -73.5771], 13);

    // Add tile layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 19,
    }).addTo(map);

    // Custom icons
    const iconStyles = {
      emergency: {
        color: "#e74c3c",
        icon: "üöë",
      },
      urgent_care: {
        color: "#f39c12",
        icon: "üè•",
      },
      clinic: {
        color: "#3498db",
        icon: "‚öïÔ∏è",
      },
    };

    function createIcon(type) {
      const style = iconStyles[type];
      return L.divIcon({
        html: `<div style="
          background: ${style.color};
          color: white;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          border: 3px solid white;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          cursor: pointer;
        ">${style.icon}</div>`,
        className: "facility-marker",
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20],
      });
    }

    function createUserIcon() {
      return L.divIcon({
        html: `<div style="
          background: #667eea;
          color: white;
          border-radius: 50%;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 18px;
          border: 3px solid white;
          box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
        ">üìç</div>`,
        className: "user-marker",
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16],
      });
    }

    let markerGroup = L.featureGroup();
    markerGroup.addTo(map);

    function renderFacilities(facilities, userLat, userLng) {
      // Clear existing markers
      markerGroup.clearLayers();

      // Add user location
      if (userLat && userLng) {
        L.marker([userLat, userLng], { icon: createUserIcon() })
          .bindPopup(
            `<div class="marker-popup">
            <div class="popup-title">Your Location</div>
            <div class="popup-info">McGill University</div>
          </div>`
          )
          .addTo(markerGroup);
      }

      // Add facilities
      facilities.forEach((facility) => {
        const popup = `
        <div class="marker-popup">
          <div class="popup-title">${facility.name}</div>
          <span class="popup-type ${facility.type}">${facility.type.replace("_", " ")}</span>
          <div class="popup-info">üìç ${facility.address}</div>
          <div class="popup-info">üìû ${facility.phone}</div>
          <div class="popup-info">‚è±Ô∏è ETA: ${facility.eta_minutes || "N/A"} min</div>
          <div class="popup-info">‚≠ê ${facility.rating}/5</div>
        </div>
      `;

        L.marker([facility.lat, facility.lng], {
          icon: createIcon(facility.type),
        })
          .bindPopup(popup)
          .addTo(markerGroup);
      });

      // Fit map bounds
      if (markerGroup.getLayers().length > 0) {
        map.fitBounds(markerGroup.getBounds().pad(0.1));
      }
    }

    function renderSidebar(facilities) {
      const list = document.getElementById("facilitiesList");

      if (!facilities || facilities.length === 0) {
        list.innerHTML =
          '<li class="no-facilities">No facilities found</li>';
        return;
      }

      list.innerHTML = facilities
        .map(
          (facility, index) => `
        <li class="facility-item" onclick="handleFacilityClick(${index})">
          <div class="facility-name">${facility.name}</div>
          <span class="facility-type ${facility.type}">
            ${facility.type.replace("_", " ")}
          </span>
          <div class="facility-info">
            ${facility.address}
          </div>
          <div class="facility-distance">
            üìç ${facility.distance_km} km away
          </div>
          <div class="facility-eta">
            ‚è±Ô∏è ETA: ${facility.eta_minutes || "N/A"} minutes
          </div>
          <div class="facility-rating">
            ‚≠ê ${facility.rating}/5
          </div>
        </li>
      `
        )
        .join("");
    }

    window.handleFacilityClick = function (index) {
      // This would be populated by the hosting application
      console.log("Facility clicked:", index);
    };

    // Listen for widget data from the parent application
    window.addEventListener("message", (event) => {
      if (event.data && event.data.type === "widget-data") {
        const { facilities, userLocation } = event.data;
        if (facilities) {
          renderFacilities(
            facilities,
            userLocation?.lat,
            userLocation?.lng
          );
          renderSidebar(facilities);
        }
      }
    });

    // Try to get data from Skybridge (OpenAI Apps SDK)
    if (window.parent && window.parent !== window) {
      window.parent.postMessage(
        { type: "widget-ready", name: "emergency-map" },
        "*"
      );
    }

    // Fallback: Load default Montreal facilities for demo
    const defaultFacilities = [
      {
        id: "mcgill-emergency",
        name: "McGill University Health Centre (MUHC)",
        type: "emergency",
        address: "1001 Boulevard D√©carie, Montreal, QC H4A 3J1",
        lat: 45.4909,
        lng: -73.6089,
        rating: "4.5",
        phone: "(514) 934-1934",
        distance_km: 1.5,
        eta_minutes: 8,
      },
      {
        id: "royal-vic",
        name: "Royal Victoria Hospital",
        type: "emergency",
        address: "687 Avenue des Pins Ouest, Montreal, QC H3A 1A1",
        lat: 45.5017,
        lng: -73.5793,
        rating: "4.4",
        phone: "(514) 842-1231",
        distance_km: 0.6,
        eta_minutes: 4,
      },
      {
        id: "jewish-general",
        name: "Jewish General Hospital",
        type: "emergency",
        address: "3755 C√¥te-Sainte-Catherine, Montreal, QC H3T 1E2",
        lat: 45.5189,
        lng: -73.6022,
        rating: "4.3",
        phone: "(514) 340-8222",
        distance_km: 2.1,
        eta_minutes: 12,
      },
      {
        id: "clinic-mcgill",
        name: "McGill Clinic - Downtown",
        type: "clinic",
        address: "3655 Drummond Street, Montreal, QC H3G 1Y1",
        lat: 45.4961,
        lng: -73.5803,
        rating: "4.3",
        phone: "(514) 289-0234",
        distance_km: 0.8,
        eta_minutes: 5,
      },
    ];

    // Render default facilities
    renderFacilities(defaultFacilities, 45.5047, -73.5771);
    renderSidebar(defaultFacilities);

    // Add legend
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
      <div class="legend-item">
        <div class="legend-color emergency"></div>
        <span>Emergency Room</span>
      </div>
      <div class="legend-item">
        <div class="legend-color urgent_care"></div>
        <span>Urgent Care</span>
      </div>
      <div class="legend-item">
        <div class="legend-color clinic"></div>
        <span>Clinic</span>
      </div>
      <div class="legend-item">
        <div class="legend-color user"></div>
        <span>Your Location</span>
      </div>
    `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
